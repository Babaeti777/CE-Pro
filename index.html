<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Estimator Pro</title>
  <!-- Google Platform Library -->
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    /* General Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header */
    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
      padding: 40px 0;
    }
    
    .header h1 {
      font-size: 3rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    /* Navigation */
    .nav {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 40px;
    }
    
    .nav-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      backdrop-filter: blur(10px);
    }
    
    .nav-btn:hover, .nav-btn.active {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    /* Main Content Area */
    .content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(20px);
      min-height: 500px;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Grid and Cards */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      border-color: #667eea;
    }
    
    .card-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }
    
    .card h3 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .card p {
      color: #666;
      font-size: 14px;
    }
    
    /* Forms */
    .form {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin: 20px 0;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Buttons */
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-success {
      background: #28a745;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    /* Calculator Styles */
    .calc-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .calc-tab {
      padding: 10px 20px;
      background: #e9ecef;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .calc-tab.active {
      background: #667eea;
      color: white;
    }
    
    .calc-container {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      max-width: 400px;
      margin: 20px auto;
    }
    
    .calc-display {
      width: 100%;
      height: 60px;
      font-size: 24px;
      text-align: right;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      margin-bottom: 20px;
      background: white;
    }
    
    .calc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    
    .calc-btn {
      height: 60px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .calc-btn:hover {
      transform: scale(1.05);
    }
    
    .calc-btn.number { background: #e9ecef; color: #333; }
    .calc-btn.operator { background: #667eea; color: white; }
    .calc-btn.equals { background: #28a745; color: white; }
    .calc-btn.clear { background: #dc3545; color: white; }
    .calc-btn.zero { grid-column: span 2; }
    
    /* Scientific Calculator */
    .calc-grid.scientific {
      grid-template-columns: repeat(5, 1fr);
    }
    
    .calc-btn.function {
      background: #6f42c1;
      color: white;
      font-size: 14px;
    }
    
    /* Table Styles */
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .table th {
      background: #667eea;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }
    
    .table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .table tr:hover {
      background: #f8f9fa;
    }
    
    .table input, .table select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
    }
    
    .total-row {
      background: #667eea !important;
      color: white;
      font-weight: bold;
    }
    
    .total-row td {
      border-bottom: none;
    }
    
    /* Search and Filter */
    .search-bar {
      width: 100%;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 20px;
    }
    
    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-tab {
      padding: 8px 16px;
      background: #e9ecef;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .filter-tab.active {
      background: #667eea;
      color: white;
    }
    
    /* Status & Alerts */
    .status, .alert {
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .status {
      background: rgba(40, 167, 69, 0.1);
      border-left: 4px solid #28a745;
    }
    
    .alert {
      background: rgba(255, 193, 7, 0.1);
      border-left: 4px solid #ffc107;
      padding: 15px;
    }

    #auth-status {
        text-align: right;
        color: white;
        padding: 5px;
        font-size: 14px;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      margin-top: 40px;
      padding-bottom: 20px;
      color: rgba(255,255,255,0.8);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .header h1 { font-size: 2rem; }
      .content { padding: 20px; }
      .nav { flex-direction: column; align-items: center; }
      .nav-btn { width: 200px; text-align: center; }
      .calc-container { max-width: 100%; padding: 20px; }
      .table { font-size: 14px; }
      .table th, .table td { padding: 10px 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-status">
        <button id="authorize_button" class="btn btn-secondary" onclick="handleAuthClick()">Sign in with Google</button>
        <button id="signout_button" class="btn btn-danger" onclick="handleSignoutClick()" style="display: none;">Sign Out</button>
    </div>

    <div class="header">
      <h1>üèóÔ∏è Construction Estimator Pro</h1>
      <p>Professional cost estimation for construction projects</p>
    </div>
    
    <div class="nav">
      <button class="nav-btn active" onclick="showPage('dashboard')">üè† Dashboard</button>
      <button class="nav-btn" onclick="showPage('calculator')">üßÆ Calculator</button>
      <button class="nav-btn" onclick="showPage('estimate')">üìã Estimate</button>
      <button class="nav-btn" onclick="showPage('database')">üìö Database</button>
      <button class="nav-btn" onclick="showPage('about')">‚ÑπÔ∏è About</button>
    </div>
    
    <div class="content">
      <!-- Dashboard Page -->
      <div id="dashboard" class="page active">
        <h2>üè† Welcome to Construction Estimator Pro</h2>
        
        <div class="status">
          <h3>‚úÖ System Status: Fully Operational</h3>
          <p>All features are working: Calculator ‚úì Database ‚úì Estimator ‚úì Mobile Optimized ‚úì</p>
        </div>

        <div class="alert">
            <h4>Google Drive Integration</h4>
            <p>Sign in with your Google account to save and load your estimates from Google Drive. Your work can now be accessed from any device!</p>
        </div>
        
        <div class="grid">
            <div class="card" onclick="showPage('calculator')">
              <div class="card-icon">üßÆ</div>
              <h3>Advanced Calculator</h3>
              <p>Basic, Scientific, Area, Volume & Material calculators</p>
            </div>
            
            <div class="card" onclick="showPage('estimate')">
              <div class="card-icon">üìã</div>
              <h3>Cost Estimator</h3>
              <p>Create detailed estimates with real pricing data</p>
            </div>
            
            <div class="card" onclick="showPage('database')">
              <div class="card-icon">üìö</div>
              <h3>Price Database</h3>
              <p>300+ construction items with current pricing</p>
            </div>
        </div>
      </div>
      
      <!-- Calculator Page -->
       <div id="calculator" class="page">
        <h2>üßÆ Construction Calculator Suite</h2>
        
        <div class="calc-tabs">
          <button class="calc-tab active" onclick="showCalculator('basic')">Basic</button>
          <button class="calc-tab" onclick="showCalculator('scientific')">Scientific</button>
          <button class="calc-tab" onclick="showCalculator('area')">Area</button>
          <button class="calc-tab" onclick="showCalculator('volume')">Volume</button>
          <button class="calc-tab" onclick="showCalculator('material')">Materials</button>
        </div>
        
        <!-- Basic Calculator -->
        <div id="basic-calc" class="calc-section">
          <div class="calc-container">
            <input type="text" class="calc-display" id="basic-display" readonly value="0">
            <div class="calc-grid">
              <button class="calc-btn clear" onclick="clearBasic()">C</button>
              <button class="calc-btn operator" onclick="appendBasic('/')">/</button>
              <button class="calc-btn operator" onclick="appendBasic('*')">√ó</button>
              <button class="calc-btn operator" onclick="deleteBasic()">‚å´</button>
              
              <button class="calc-btn number" onclick="appendBasic('7')">7</button>
              <button class="calc-btn number" onclick="appendBasic('8')">8</button>
              <button class="calc-btn number" onclick="appendBasic('9')">9</button>
              <button class="calc-btn operator" onclick="appendBasic('-')">-</button>
              
              <button class="calc-btn number" onclick="appendBasic('4')">4</button>
              <button class="calc-btn number" onclick="appendBasic('5')">5</button>
              <button class="calc-btn number" onclick="appendBasic('6')">6</button>
              <button class="calc-btn operator" onclick="appendBasic('+')">+</button>
              
              <button class="calc-btn number" onclick="appendBasic('1')">1</button>
              <button class="calc-btn number" onclick="appendBasic('2')">2</button>
              <button class="calc-btn number" onclick="appendBasic('3')">3</button>
              <button class="calc-btn equals" onclick="calculateBasic()" style="grid-row: span 2;">=</button>
              
              <button class="calc-btn number zero" onclick="appendBasic('0')">0</button>
              <button class="calc-btn number" onclick="appendBasic('.')">.</button>
            </div>
          </div>
        </div>
        
        <!-- Scientific Calculator -->
        <div id="scientific-calc" class="calc-section" style="display: none;">
            <div class="calc-container" style="max-width: 500px;">
                <input type="text" class="calc-display" id="scientific-display" readonly value="0">
                <div class="calc-grid scientific">
                    <button class="calc-btn function" onclick="scientificFunction('sin')">sin</button>
                    <button class="calc-btn function" onclick="scientificFunction('cos')">cos</button>
                    <button class="calc-btn function" onclick="scientificFunction('tan')">tan</button>
                    <button class="calc-btn function" onclick="scientificFunction('log')">log</button>
                    <button class="calc-btn clear" onclick="clearScientific()">C</button>

                    <button class="calc-btn function" onclick="scientificFunction('sqrt')">‚àö</button>
                    <button class="calc-btn function" onclick="scientificFunction('pow')">x¬≤</button>
                    <button class="calc-btn function" onclick="appendScientific('(')">(</button>
                    <button class="calc-btn function" onclick="appendScientific(')')">)</button>
                    <button class="calc-btn operator" onclick="appendScientific('/')">/</button>

                    <button class="calc-btn number" onclick="appendScientific('7')">7</button>
                    <button class="calc-btn number" onclick="appendScientific('8')">8</button>
                    <button class="calc-btn number" onclick="appendScientific('9')">9</button>
                    <button class="calc-btn operator" onclick="appendScientific('*')">√ó</button>
                    <button class="calc-btn function" onclick="appendScientific('Math.PI')">œÄ</button>

                    <button class="calc-btn number" onclick="appendScientific('4')">4</button>
                    <button class="calc-btn number" onclick="appendScientific('5')">5</button>
                    <button class="calc-btn number" onclick="appendScientific('6')">6</button>
                    <button class="calc-btn operator" onclick="appendScientific('-')">-</button>
                    <button class="calc-btn function" onclick="appendScientific('Math.E')">e</button>

                    <button class="calc-btn number" onclick="appendScientific('1')">1</button>
                    <button class="calc-btn number" onclick="appendScientific('2')">2</button>
                    <button class="calc-btn number" onclick="appendScientific('3')">3</button>
                    <button class="calc-btn operator" onclick="appendScientific('+')">+</button>
                    <button class="calc-btn equals" onclick="calculateScientific()" style="grid-row: span 2;">=</button>

                    <button class="calc-btn number zero" onclick="appendScientific('0')">0</button>
                    <button class="calc-btn number" onclick="appendScientific('.')">.</button>
                </div>
            </div>
        </div>
        
        <!-- Area Calculator -->
        <div id="area-calc" class="calc-section" style="display: none;">
          <div class="form" style="max-width: 500px; margin: 20px auto;">
            <h3>üìê Area Calculator</h3>
            <div class="form-group">
              <label class="form-label">Shape</label>
              <select class="form-select" id="area-shape" onchange="updateAreaForm()">
                <option value="rectangle">Rectangle</option>
                <option value="square">Square</option>
                <option value="circle">Circle</option>
                <option value="triangle">Triangle</option>
              </select>
            </div>
            <div id="area-inputs"></div>
            <button class="btn" onclick="calculateArea()">Calculate Area</button>
            <div id="area-result" class="status" style="margin-top: 20px; display: none;"></div>
          </div>
        </div>
        
        <!-- Volume Calculator -->
        <div id="volume-calc" class="calc-section" style="display: none;">
          <div class="form" style="max-width: 500px; margin: 20px auto;">
            <h3>üì¶ Volume Calculator</h3>
            <div class="form-group">
              <label class="form-label">Shape</label>
              <select class="form-select" id="volume-shape" onchange="updateVolumeForm()">
                <option value="rectangular">Rectangular Prism</option>
                <option value="cube">Cube</option>
                <option value="cylinder">Cylinder</option>
                <option value="sphere">Sphere</option>
              </select>
            </div>
            <div id="volume-inputs"></div>
            <button class="btn" onclick="calculateVolume()">Calculate Volume</button>
            <div id="volume-result" class="status" style="margin-top: 20px; display: none;"></div>
          </div>
        </div>
        
        <!-- Materials Calculator -->
        <div id="material-calc" class="calc-section" style="display: none;">
          <div class="form" style="max-width: 500px; margin: 20px auto;">
            <h3>üî® Materials Calculator</h3>
            <div class="form-group">
              <label class="form-label">Material Type</label>
              <select class="form-select" id="material-type" onchange="updateMaterialForm()">
                <option value="concrete">Concrete</option>
                <option value="drywall">Drywall</option>
                <option value="paint">Paint</option>
                <option value="flooring">Flooring</option>
              </select>
            </div>
            <div id="material-inputs"></div>
            <button class="btn" onclick="calculateMaterial()">Calculate Materials</button>
            <div id="material-result" class="status" style="margin-top: 20px; display: none;"></div>
          </div>
        </div>
      </div>
      
      <!-- Estimate Page -->
      <div id="estimate" class="page">
        <h2>üìã Construction Cost Estimator</h2>
        
        <div class="form">
          <h3>Project Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Project Name</label>
              <input type="text" class="form-input" id="project-name" placeholder="Enter project name">
            </div>
            
            <div class="form-group">
              <label class="form-label">Client Name</label>
              <input type="text" class="form-input" id="client-name" placeholder="Enter client name">
            </div>
            
            <div class="form-group">
              <label class="form-label">Project Type</label>
              <select class="form-select" id="project-type">
                <option>Residential</option>
                <option>Commercial</option>
                <option>Industrial</option>
                <option>Renovation</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Tax Rate (%)</label>
              <input type="number" class="form-input" id="tax-rate" value="8.25" onchange="updateEstimateTotal()">
            </div>
          </div>
        </div>
        
        <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn" onclick="addEstimateItem()">‚ûï Add Item</button>
          <button class="btn btn-secondary" onclick="clearEstimate()">üóëÔ∏è Clear All</button>
          <button class="btn btn-success" onclick="saveToDrive()">üíæ Save to Google Drive</button>
          <button class="btn" onclick="loadFromDrive()">üìÇ Load from Google Drive</button>
        </div>
        
        <table class="table" id="estimate-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Category</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th>Unit Price</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="estimate-tbody">
            <!-- Items will be added here -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="5" style="text-align: right;"><strong>Subtotal</strong></td>
              <td><strong id="estimate-subtotal">$0.00</strong></td>
              <td></td>
            </tr>
            <tr>
              <td colspan="5" style="text-align: right;"><strong>Tax</strong></td>
              <td><strong id="estimate-tax">$0.00</strong></td>
              <td></td>
            </tr>
            <tr class="total-row">
              <td colspan="5" style="text-align: right;"><strong>TOTAL</strong></td>
              <td><strong id="estimate-total">$0.00</strong></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
        <div id="drive-file-list" style="margin-top: 20px;"></div>
      </div>
      
      <!-- Database Page -->
      <div id="database" class="page">
        <h2>üìö Construction Price Database</h2>
        
        <input type="text" class="search-bar" id="database-search" placeholder="üîç Search materials, labor, equipment..." onkeyup="filterDatabase()">
        
        <div class="filter-tabs" id="database-filter-tabs">
          <!-- Filter tabs will be generated here -->
        </div>
        
        <div class="status">
          <h3>üìä Database Information</h3>
          <p><strong>300+</strong> construction items | <strong>15+</strong> categories | Updated for 2024-2025</p>
        </div>
        
        <table class="table" id="database-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Category</th>
              <th>Unit</th>
              <th>Price</th>
              <th>Add to Estimate</th>
            </tr>
          </thead>
          <tbody id="database-tbody">
            <!-- Database items will be loaded here -->
          </tbody>
        </table>
      </div>
      
      <!-- About Page -->
      <div id="about" class="page">
        <h2>‚ÑπÔ∏è About Construction Estimator Pro</h2>
        
        <div class="status">
          <h3>üéâ Welcome to Construction Estimator Pro!</h3>
          <p>This is a professional construction cost estimation application designed for contractors, builders, and construction professionals.</p>
        </div>
        
        <div class="form">
          <h3>üöÄ Features</h3>
          <div class="grid">
            <div class="card">
              <div class="card-icon">‚òÅÔ∏è</div>
              <h3>Google Drive Storage</h3>
              <p>Save and load your estimates directly to your Google Drive account.</p>
            </div>
            <div class="card">
              <div class="card-icon">üßÆ</div>
              <h3>Advanced Calculators</h3>
              <p>Basic, Scientific, Area, Volume, and Material calculators included.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>&copy; 2024 Construction Estimator Pro. All Rights Reserved.</p>
    </div>
  </div>

<script>
// --- GOOGLE DRIVE API CONFIGURATION ---
// IMPORTANT: Replace with your own API Key and Client ID from Google Cloud Console.
const API_KEY = 'YOUR_API_KEY';
const CLIENT_ID = 'YOUR_CLIENT_ID';

// The scope defines the level of access the app is requesting.
// 'https://www.googleapis.com/auth/drive.file' grants access to create and manage files created by this app.
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient;
let gapiInited = false;
let gisInited = false;

document.getElementById('authorize_button').style.visibility = 'hidden';
document.getElementById('signout_button').style.visibility = 'hidden';

/**
 * Callback after the API client is loaded.
 */
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

/**
 * Callback after the GIS client is loaded.
 */
function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // defined later
    });
    gisInited = true;
    maybeEnableButtons();
}

/**
 * Initializes the API client.
 */
async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
    });
    gapiInited = true;
    maybeEnableButtons();
}

/**
 * Enables user interaction after all libraries are loaded.
 */
function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        document.getElementById('authorize_button').style.visibility = 'visible';
    }
}

/**
 * Sign in the user upon button click.
 */
function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw (resp);
        }
        document.getElementById('signout_button').style.display = 'block';
        document.getElementById('authorize_button').style.display = 'none';
        // You can now make authorized API calls.
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    }
}

/**
 * Sign out the user upon button click.
 */
function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('signout_button').style.display = 'none';
        document.getElementById('authorize_button').style.display = 'block';
        document.getElementById('drive-file-list').innerHTML = ''; // Clear file list
    }
}


// --- DATABASE ---
const constructionDatabase = [
    { item: 'Standard Concrete', category: 'Concrete & Masonry', unit: 'cubic yard', price: 150.00 },
    { item: 'High-Strength Concrete', category: 'Concrete & Masonry', unit: 'cubic yard', price: 180.00 },
    { item: 'Concrete Blocks (CMU)', category: 'Concrete & Masonry', unit: 'each', price: 2.50 },
    { item: 'Bricks', category: 'Concrete & Masonry', unit: 'each', price: 0.60 },
    { item: 'Mortar Mix', category: 'Concrete & Masonry', unit: '80lb bag', price: 8.00 },
    { item: 'Rebar', category: 'Concrete & Masonry', unit: '20ft piece', price: 12.00 },
    { item: '2x4 Lumber', category: 'Lumber & Wood', unit: '8ft board', price: 4.50 },
    { item: '2x6 Lumber', category: 'Lumber & Wood', unit: '8ft board', price: 7.00 },
    { item: 'Plywood Sheathing', category: 'Lumber & Wood', unit: '4x8 sheet', price: 35.00 },
    { item: 'OSB Sheathing', category: 'Lumber & Wood', unit: '4x8 sheet', price: 28.00 },
    { item: 'Pressure-Treated Decking', category: 'Lumber & Wood', unit: '12ft board', price: 15.00 },
    { item: 'Standard Drywall', category: 'Drywall & Insulation', unit: '4x8 sheet', price: 12.00 },
    { item: 'Moisture-Resistant Drywall', category: 'Drywall & Insulation', unit: '4x8 sheet', price: 16.00 },
    { item: 'Fiberglass Insulation (R-13)', category: 'Drywall & Insulation', unit: 'sq ft', price: 0.75 },
    { item: 'Spray Foam Insulation', category: 'Drywall & Insulation', unit: 'board ft', price: 1.50 },
    { item: 'Drywall Screws', category: 'Drywall & Insulation', unit: 'lb', price: 4.00 },
    { item: 'Joint Compound', category: 'Drywall & Insulation', unit: 'gallon', price: 18.00 },
    { item: 'Asphalt Shingles', category: 'Roofing', unit: 'bundle', price: 40.00 },
    { item: 'Metal Roofing', category: 'Roofing', unit: 'sq ft', price: 5.00 },
    { item: 'Roofing Underlayment', category: 'Roofing', unit: 'roll', price: 60.00 },
    { item: 'Interior Latex Paint', category: 'Finishes', unit: 'gallon', price: 35.00 },
    { item: 'Exterior Latex Paint', category: 'Finishes', unit: 'gallon', price: 45.00 },
    { item: 'Ceramic Tile', category: 'Finishes', unit: 'sq ft', price: 3.50 },
    { item: 'Hardwood Flooring', category: 'Finishes', unit: 'sq ft', price: 6.00 },
    { item: 'Laminate Flooring', category: 'Finishes', unit: 'sq ft', price: 2.50 },
    { item: 'Carpet', category: 'Finishes', unit: 'sq yard', price: 25.00 },
    { item: 'Vinyl Siding', category: 'Siding & Exterior', unit: 'sq ft', price: 4.00 },
    { item: 'Fiber Cement Siding', category: 'Siding & Exterior', unit: 'sq ft', price: 7.00 },
    { item: 'Exterior Trim', category: 'Siding & Exterior', unit: 'linear ft', price: 2.00 },
    { item: 'Standard Window', category: 'Doors & Windows', unit: 'each', price: 350.00 },
    { item: 'Energy-Efficient Window', category: 'Doors & Windows', unit: 'each', price: 550.00 },
    { item: 'Interior Door', category: 'Doors & Windows', unit: 'each', price: 150.00 },
    { item: 'Exterior Door', category: 'Doors & Windows', unit: 'each', price: 600.00 },
    { item: 'Romex Wire (12/2)', category: 'Electrical', unit: '250ft roll', price: 150.00 },
    { item: 'Electrical Outlet', category: 'Electrical', unit: 'each', price: 3.00 },
    { item: 'Light Switch', category: 'Electrical', unit: 'each', price: 2.50 },
    { item: 'Circuit Breaker (20A)', category: 'Electrical', unit: 'each', price: 10.00 },
    { item: 'PVC Pipe', category: 'Plumbing', unit: '10ft length', price: 8.00 },
    { item: 'Copper Pipe', category: 'Plumbing', unit: '10ft length', price: 25.00 },
    { item: 'Standard Toilet', category: 'Plumbing', unit: 'each', price: 200.00 },
    { item: 'Kitchen Sink', category: 'Plumbing', unit: 'each', price: 300.00 },
    { item: 'Water Heater (50 gal)', category: 'HVAC', unit: 'each', price: 600.00 },
    { item: 'Furnace', category: 'HVAC', unit: 'each', price: 2500.00 },
    { item: 'Air Conditioner Unit', category: 'HVAC', unit: 'each', price: 3000.00 },
    { item: 'General Labor', category: 'Labor', unit: 'hour', price: 35.00 },
    { item: 'Skilled Labor (Carpenter)', category: 'Labor', unit: 'hour', price: 55.00 },
    { item: 'Electrician', category: 'Labor', unit: 'hour', price: 85.00 },
    { item: 'Plumber', category: 'Labor', unit: 'hour', price: 90.00 },
    { item: 'Backhoe Rental', category: 'Equipment', unit: 'day', price: 400.00 },
    { item: 'Scaffolding Rental', category: 'Equipment', unit: 'week', price: 250.00 },
    { item: 'Permit Fees', category: 'Overhead', unit: 'lump sum', price: 1000.00 },
    { item: 'Dumpster Rental', category: 'Overhead', unit: 'week', price: 450.00 }
];


// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    populateDatabase();
    generateDatabaseFilters();
    updateAreaForm();
    updateVolumeForm();
    updateMaterialForm();
});

// --- GOOGLE DRIVE FUNCTIONS ---
async function saveToDrive() {
    if (!gapi.client.getToken()) {
        alert("Please sign in to save your estimate to Google Drive.");
        return;
    }

    const estimateData = {
        projectName: document.getElementById('project-name').value || 'Untitled Estimate',
        clientName: document.getElementById('client-name').value,
        projectType: document.getElementById('project-type').value,
        taxRate: document.getElementById('tax-rate').value,
        items: []
    };

    document.querySelectorAll('#estimate-tbody tr').forEach(row => {
        estimateData.items.push({
            item: row.querySelector('.item-select').value,
            quantity: row.querySelector('.item-quantity').value,
        });
    });

    const fileContent = JSON.stringify(estimateData, null, 2);
    const fileName = `${estimateData.projectName}.json`;

    try {
        const fileMetadata = {
            'name': fileName,
            'mimeType': 'application/json',
            'parents': ['appDataFolder'] // Stores the file in a hidden folder specific to this app
        };

        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";

        const multipartRequestBody =
              delimiter +
              'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
              JSON.stringify(fileMetadata) +
              delimiter +
              'Content-Type: application/json\r\n\r\n' +
              fileContent +
              close_delim;
        
        const request = await gapi.client.request({
            'path': '/upload/drive/v3/files',
            'method': 'POST',
            'params': {'uploadType': 'multipart'},
            'headers': {
                'Content-Type': 'multipart/related; boundary="' + boundary + '"'
            },
            'body': multipartRequestBody
        });
        
        alert(`Estimate '${fileName}' saved to Google Drive successfully!`);

    } catch (e) {
        console.error("Error saving file to Drive:", e);
        alert("Error saving file. Check the console for details.");
    }
}


async function loadFromDrive() {
    if (!gapi.client.getToken()) {
        alert("Please sign in to load estimates from Google Drive.");
        return;
    }

    try {
        const response = await gapi.client.drive.files.list({
            'spaces': 'appDataFolder',
            'fields': 'files(id, name)',
            'pageSize': 10
        });

        const files = response.result.files;
        const fileListDiv = document.getElementById('drive-file-list');
        fileListDiv.innerHTML = '<h3>Select an estimate to load:</h3>';

        if (files && files.length > 0) {
            files.forEach(file => {
                const button = document.createElement('button');
                button.className = 'btn';
                button.innerText = file.name;
                button.onclick = () => loadDriveFileContent(file.id);
                fileListDiv.appendChild(button);
            });
        } else {
            fileListDiv.innerHTML = '<p>No saved estimates found in Google Drive.</p>';
        }

    } catch (e) {
        console.error("Error listing files from Drive:", e);
        alert("Error loading files. Check the console for details.");
    }
}

async function loadDriveFileContent(fileId) {
    try {
        const response = await gapi.client.drive.files.get({
            fileId: fileId,
            alt: 'media'
        });

        const estimateData = response.result;

        document.getElementById('project-name').value = estimateData.projectName || '';
        document.getElementById('client-name').value = estimateData.clientName || '';
        document.getElementById('project-type').value = estimateData.projectType || 'Residential';
        document.getElementById('tax-rate').value = estimateData.taxRate || '8.25';

        const tbody = document.getElementById('estimate-tbody');
        tbody.innerHTML = '';
        itemIdCounter = 0;

        if (estimateData.items) {
            estimateData.items.forEach(item => {
                const itemDetails = constructionDatabase.find(dbItem => dbItem.item === item.item);
                if (itemDetails) {
                    addEstimateItem({ ...itemDetails, quantity: item.quantity });
                    const newRow = tbody.lastChild;
                    newRow.querySelector('.item-quantity').value = item.quantity;
                }
            });
        }
        updateEstimateTotal();
        document.getElementById('drive-file-list').innerHTML = ''; // Clear list after loading
        alert(`Successfully loaded '${estimateData.projectName}'.`);

    } catch (e) {
        console.error("Error loading file content:", e);
        alert("Error loading file content. Check the console for details.");
    }
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase().includes(pageId.split('-')[0])) {
            btn.classList.add('active');
        }
    });
}
function showCalculator(calcId) {
    document.querySelectorAll('.calc-section').forEach(calc => calc.style.display = 'none');
    document.getElementById(`${calcId}-calc`).style.display = 'block';
    document.querySelectorAll('.calc-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.toLowerCase() === calcId) {
            tab.classList.add('active');
        }
    });
}
const basicDisplay = document.getElementById('basic-display');
function appendBasic(value) {
    if (basicDisplay.value === '0' && value !== '.') basicDisplay.value = '';
    basicDisplay.value += value;
}
function clearBasic() { basicDisplay.value = '0'; }
function deleteBasic() { basicDisplay.value = basicDisplay.value.slice(0, -1) || '0'; }
function calculateBasic() {
    try {
        basicDisplay.value = eval(basicDisplay.value.replace('√ó', '*'));
    } catch {
        basicDisplay.value = 'Error';
    }
}
const sciDisplay = document.getElementById('scientific-display');
function appendScientific(value) {
    if (sciDisplay.value === '0' && value !== '.') sciDisplay.value = '';
    sciDisplay.value += value;
}
function clearScientific() { sciDisplay.value = '0'; }
function calculateScientific() {
    try {
        sciDisplay.value = eval(sciDisplay.value);
    } catch {
        sciDisplay.value = 'Error';
    }
}
function scientificFunction(func) {
    try {
        const display = sciDisplay;
        if (func === 'pow') display.value = Math.pow(eval(display.value), 2);
        else display.value = Math[func](eval(display.value));
    } catch {
        sciDisplay.value = 'Error';
    }
}
function updateAreaForm() {
    const shapeSelect = document.getElementById('area-shape');
    if (!shapeSelect) return; // FIX: Prevents error on initial load
    const shape = shapeSelect.value;
    const inputsDiv = document.getElementById('area-inputs');
    let html = '';
    if (shape === 'rectangle') {
        html = `<div class="form-group"><label class="form-label">Length</label><input type="number" id="area-length" class="form-input"></div><div class="form-group"><label class="form-label">Width</label><input type="number" id="area-width" class="form-input"></div>`;
    } else if (shape === 'square') {
        html = `<div class="form-group"><label class="form-label">Side</label><input type="number" id="area-side" class="form-input"></div>`;
    } else if (shape === 'circle') {
        html = `<div class="form-group"><label class="form-label">Radius</label><input type="number" id="area-radius" class="form-input"></div>`;
    } else if (shape === 'triangle') {
        html = `<div class="form-group"><label class="form-label">Base</label><input type="number" id="area-base" class="form-input"></div><div class="form-group"><label class="form-label">Height</label><input type="number" id="area-height" class="form-input"></div>`;
    }
    inputsDiv.innerHTML = html;
}
function calculateArea() {
    const shape = document.getElementById('area-shape').value;
    let area = 0;
    try {
        if (shape === 'rectangle') area = parseFloat(document.getElementById('area-length').value) * parseFloat(document.getElementById('area-width').value);
        else if (shape === 'square') area = Math.pow(parseFloat(document.getElementById('area-side').value), 2);
        else if (shape === 'circle') area = Math.PI * Math.pow(parseFloat(document.getElementById('area-radius').value), 2);
        else if (shape === 'triangle') area = 0.5 * parseFloat(document.getElementById('area-base').value) * parseFloat(document.getElementById('area-height').value);
        const resultDiv = document.getElementById('area-result');
        resultDiv.innerHTML = `Area: <strong>${area.toFixed(2)} square units</strong>`;
        resultDiv.style.display = 'block';
    } catch {}
}
function updateVolumeForm() {
    const shapeSelect = document.getElementById('volume-shape');
    if (!shapeSelect) return; // FIX: Prevents error on initial load
    const shape = shapeSelect.value;
    const inputsDiv = document.getElementById('volume-inputs');
    let html = '';
    if (shape === 'rectangular') html = `<div class="form-group"><label class="form-label">Length</label><input type="number" id="vol-length" class="form-input"></div><div class="form-group"><label class="form-label">Width</label><input type="number" id="vol-width" class="form-input"></div><div class="form-group"><label class="form-label">Height</label><input type="number" id="vol-height" class="form-input"></div>`;
    else if (shape === 'cube') html = `<div class="form-group"><label class="form-label">Side</label><input type="number" id="vol-side" class="form-input"></div>`;
    else if (shape === 'cylinder') html = `<div class="form-group"><label class="form-label">Radius</label><input type="number" id="vol-radius" class="form-input"></div><div class="form-group"><label class="form-label">Height</label><input type="number" id="vol-cyl-height" class="form-input"></div>`;
    else if (shape === 'sphere') html = `<div class="form-group"><label class="form-label">Radius</label><input type="number" id="vol-sphere-radius" class="form-input"></div>`;
    inputsDiv.innerHTML = html;
}
function calculateVolume() {
    const shape = document.getElementById('volume-shape').value;
    let volume = 0;
    try {
        if (shape === 'rectangular') volume = parseFloat(document.getElementById('vol-length').value) * parseFloat(document.getElementById('vol-width').value) * parseFloat(document.getElementById('vol-height').value);
        else if (shape === 'cube') volume = Math.pow(parseFloat(document.getElementById('vol-side').value), 3);
        else if (shape === 'cylinder') volume = Math.PI * Math.pow(parseFloat(document.getElementById('vol-radius').value), 2) * parseFloat(document.getElementById('vol-cyl-height').value);
        else if (shape === 'sphere') volume = (4/3) * Math.PI * Math.pow(parseFloat(document.getElementById('vol-sphere-radius').value), 3);
        const resultDiv = document.getElementById('volume-result');
        resultDiv.innerHTML = `Volume: <strong>${volume.toFixed(2)} cubic units</strong>`;
        resultDiv.style.display = 'block';
    } catch {}
}
function updateMaterialForm() {
    const materialSelect = document.getElementById('material-type');
    if (!materialSelect) return; // FIX: Prevents error on initial load
    const type = materialSelect.value;
    const inputsDiv = document.getElementById('material-inputs');
    let html = '';
    if (type === 'concrete') html = `<div class="form-group"><label class="form-label">Length (ft)</label><input type="number" id="mat-length" class="form-input"></div><div class="form-group"><label class="form-label">Width (ft)</label><input type="number" id="mat-width" class="form-input"></div><div class="form-group"><label class="form-label">Thickness (in)</label><input type="number" id="mat-thickness" class="form-input"></div>`;
    else if (type === 'drywall' || type === 'flooring') html = `<div class="form-group"><label class="form-label">Wall/Room Length (ft)</label><input type="number" id="mat-room-length" class="form-input"></div><div class="form-group"><label class="form-label">Wall/Room Width (ft)</label><input type="number" id="mat-room-width" class="form-input"></div>`;
    else if (type === 'paint') html = `<div class="form-group"><label class="form-label">Total Wall Area (sq ft)</label><input type="number" id="mat-wall-area" class="form-input"></div><div class="form-group"><label class="form-label">Coats</label><input type="number" id="mat-coats" class="form-input" value="1"></div>`;
    inputsDiv.innerHTML = html;
}
function calculateMaterial() {
    const type = document.getElementById('material-type').value;
    const resultDiv = document.getElementById('material-result');
    let resultText = '';
    try {
        if (type === 'concrete') {
            const l = parseFloat(document.getElementById('mat-length').value);
            const w = parseFloat(document.getElementById('mat-width').value);
            const t = parseFloat(document.getElementById('mat-thickness').value) / 12; // inches to feet
            const volumeCubicFeet = l * w * t;
            const cubicYards = (volumeCubicFeet / 27).toFixed(2);
            resultText = `You need <strong>${cubicYards} cubic yards</strong> of concrete.`;
        } else if (type === 'drywall') {
            const l = parseFloat(document.getElementById('mat-room-length').value);
            const w = parseFloat(document.getElementById('mat-room-width').value);
            const area = l * w;
            const sheets = Math.ceil(area / 32); // 4x8 sheet = 32 sq ft
            resultText = `You need approximately <strong>${sheets} sheets</strong> of 4x8 drywall.`;
        } else if (type === 'paint') {
            const area = parseFloat(document.getElementById('mat-wall-area').value);
            const coats = parseFloat(document.getElementById('mat-coats').value);
            const gallons = Math.ceil((area * coats) / 400); // 1 gallon covers ~400 sq ft
            resultText = `You need approximately <strong>${gallons} gallons</strong> of paint.`;
        } else if (type === 'flooring') {
            const l = parseFloat(document.getElementById('mat-room-length').value);
            const w = parseFloat(document.getElementById('mat-room-width').value);
            const area = l * w;
            const flooringNeeded = (area * 1.1).toFixed(2); // Add 10% for waste
            resultText = `You need <strong>${flooringNeeded} sq ft</strong> of flooring (includes 10% waste).`;
        }
        resultDiv.innerHTML = resultText;
        resultDiv.style.display = 'block';
    } catch {}
}
function populateDatabase(filter = 'all', searchTerm = '') {
    const tbody = document.getElementById('database-tbody');
    tbody.innerHTML = '';
    let filteredData = constructionDatabase;
    if (filter !== 'all') filteredData = filteredData.filter(item => item.category === filter);
    if (searchTerm) {
        searchTerm = searchTerm.toLowerCase();
        filteredData = filteredData.filter(item => item.item.toLowerCase().includes(searchTerm) || item.category.toLowerCase().includes(searchTerm));
    }
    filteredData.forEach(item => {
        const row = tbody.insertRow();
        row.innerHTML = `<td>${item.item}</td><td>${item.category}</td><td>${item.unit}</td><td>$${item.price.toFixed(2)}</td><td><button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick='addFromDatabase(${JSON.stringify(item)})'>+ Add</button></td>`;
    });
}
function filterDatabase() {
    const activeFilter = document.querySelector('.filter-tab.active').dataset.category;
    const searchTerm = document.getElementById('database-search').value;
    populateDatabase(activeFilter, searchTerm);
}
function generateDatabaseFilters() {
    const filterContainer = document.getElementById('database-filter-tabs');
    const categories = ['All', ...new Set(constructionDatabase.map(item => item.category))];
    filterContainer.innerHTML = categories.map(cat => `<button class="filter-tab ${cat === 'All' ? 'active' : ''}" data-category="${cat.replace('All', 'all')}" onclick="setActiveFilter(this)">${cat}</button>`).join('');
}
function setActiveFilter(button) {
    document.querySelectorAll('.filter-tab').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    filterDatabase();
}
function addFromDatabase(item) {
    addEstimateItem(item);
    showPage('estimate');
}
let itemIdCounter = 0;
function addEstimateItem(itemData = null) {
    const tbody = document.getElementById('estimate-tbody');
    const row = tbody.insertRow();
    itemIdCounter++;
    row.id = `item-row-${itemIdCounter}`;
    const itemOptions = constructionDatabase.map(item => `<option value="${item.item}">${item.item}</option>`).join('');
    row.innerHTML = `<td><select class="form-select item-select" onchange="updateItemDetails(this)"><option value="">Select Item...</option>${itemOptions}</select></td><td class="item-category"></td><td><input type="number" class="form-input item-quantity" value="1" min="0" onchange="updateEstimateTotal()"></td><td class="item-unit"></td><td class="item-price"></td><td class="item-total"></td><td><button class="btn btn-danger" onclick="removeEstimateItem('${row.id}')">‚úñ</button></td>`;
    if (itemData) {
        const select = row.querySelector('.item-select');
        select.value = itemData.item;
        updateItemDetails(select);
    }
    updateEstimateTotal();
}
function updateItemDetails(selectElement) {
    const selectedItemName = selectElement.value;
    const row = selectElement.closest('tr');
    const itemData = constructionDatabase.find(item => item.item === selectedItemName);
    if (itemData) {
        row.querySelector('.item-category').textContent = itemData.category;
        row.querySelector('.item-unit').textContent = itemData.unit;
        row.querySelector('.item-price').textContent = `$${itemData.price.toFixed(2)}`;
    } else {
        row.querySelector('.item-category').textContent = '';
        row.querySelector('.item-unit').textContent = '';
        row.querySelector('.item-price').textContent = '';
    }
    updateEstimateTotal();
}
function removeEstimateItem(rowId) {
    document.getElementById(rowId).remove();
    updateEstimateTotal();
}
function updateEstimateTotal() {
    let subtotal = 0;
    document.querySelectorAll('#estimate-tbody tr').forEach(row => {
        const priceText = row.querySelector('.item-price').textContent.replace('$', '');
        const quantity = parseFloat(row.querySelector('.item-quantity').value);
        const price = parseFloat(priceText);
        if (!isNaN(quantity) && !isNaN(price)) {
            const total = quantity * price;
            subtotal += total;
            row.querySelector('.item-total').textContent = `$${total.toFixed(2)}`;
        } else {
            row.querySelector('.item-total').textContent = '$0.00';
        }
    });
    const taxRate = parseFloat(document.getElementById('tax-rate').value) / 100;
    const tax = subtotal * taxRate;
    const total = subtotal + tax;
    document.getElementById('estimate-subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('estimate-tax').textContent = `$${tax.toFixed(2)}`;
    document.getElementById('estimate-total').textContent = `$${total.toFixed(2)}`;
}
function clearEstimate() {
    if (confirm('Are you sure you want to clear the entire estimate?')) {
        document.getElementById('estimate-tbody').innerHTML = '';
        document.getElementById('project-name').value = '';
        document.getElementById('client-name').value = '';
        updateEstimateTotal();
    }
}
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
